<!-- Begin Page 1 -->
<div data-role="page" id="summary" data-url="summary" tabindex="0">

  <% if !current_user.present? %> <!-- header content -->
    <% content_for :header_title, 'How many patients did you help today?' %>
  <% else %>
    <% if policy(Encounter).summary? %>
      <% content_for :user_first_name_header, "All" %>
      <% content_for :user_last_name_header, "Residents" %>
    <% elsif current_user.first_name && current_user.last_name %>
      <% content_for :user_first_name_header, "#{current_user.first_name}" %>
      <% content_for :user_last_name_header, "#{current_user.last_name}'s" %>
    <% else %>
      <% content_for :user_last_name_header, "#{current_user.email.split('@').first}'s" %>
    <% end %>
    <% content_for :header_title, "Summary" %>
  <% end %>
  <%= render 'layouts/header' %>
  <%= render 'layouts/flash_messages' %>


  <% if !current_user %> <!-- Show sign in message if not signed in. -->

    <%= render 'layouts/sign_in_message' %>

  <% else %> <!-- Show nav. and table if signed in -->

    <div class="wrap_section_narrow encounters_summary_section">

      <table data-role="table" class="encounters_summary">
        <thead>
          <tr class="fullwidth">
            <% if policy(Encounter).summary? %>  <!-- Show name column if policy allows -->
              <th>Resident</th>
            <% end %>
            <th>Type</th>
            <th>Total</th>
          </tr>
        </thead>

        <tbody>
          <% @encounters_count.each do |group, count| %>
            <% user = User.find(group[0]) %>
            <% if user == current_user || policy(Encounter).summary? %>  <!-- Show rows belonging to the current_user or permitted rows -->
              <tr class="lineitem fullwidth">
                <% if policy(Encounter).summary? %> <!-- Show name column if policy allows -->
                  <td><%= user.name %></td>
                <% end %>
                <td><%= group[1] %></td>
                <td><%= count %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>

      <% if current_user.admin? || policy(User).index? %>
        <div id="encounters_summary_buttons" data-role="navbar">
          <ul>
            <% if current_user.admin? %>
              <li>
                <%= link_to 'Invite Resident', new_user_invitation_path, class: 'ui-shadow', data: {transition: 'flip'} %>
              </li>
            <% end %>
            <% if policy(User).index? %>
              <li>
                <%= link_to 'My Residents', users_path, class: 'ui-shadow' %>
              </li>
            <% end %>
          </ul>
        </div><!-- /navbar -->
      <% end %>
    </div>

  <% end %>

  <%= render 'layouts/footer' %>
</div>
<!-- End Page 1 -->



