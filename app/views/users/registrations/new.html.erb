<div data-role="page" data-dialog="true" data-close-btn-text="X" data-no-transition-cache>
  <!-- data-close-btn-text="X" Will this attribute show an X in IE8 -->
  <div data-role="header">
    <h2>Sign Up</h2>
  </div><!-- data-role="header" -->

  <%= render 'layouts/flash_messages' %>

  <%= form_for(resource, as: resource_name, url: registration_path(resource_name),
    html: { class: "new_user_registration", id: "new_user_registration" }) do |f| %>

    <%= devise_error_messages! %>

    <%= hidden_field_tag 'stripeToken' %>
    <%= hidden_field_tag 'stripeEmail' %>
    <%= hidden_field_tag 'chargeForm' %>

    <%= f.label :first_name, class: 'ui-hidden-accessible' %>
    <%= f.text_field :first_name, data: { clear_btn: true },
      placeholder: 'First Name', value: '' %>

    <%= f.label :last_name, class: 'ui-hidden-accessible' %>
    <%= f.text_field :last_name, data: { clear_btn: true },
      placeholder: 'Last Name', value: '' %>

    <%= f.label :password, class: 'ui-hidden-accessible' %>
    <%= f.password_field :password,
      autocomplete: "off", placeholder: 'Password', value: '' %>

    <%= f.label :password_confirmation, class: 'ui-hidden-accessible' %>
    <%= f.password_field :password_confirmation,
      autocomplete: "off", placeholder: 'Confirm Password', value: '' %>

    <fieldset data-role="controlgroup" data-type="horizontal">
      <input type="radio" name="plan" id="monthly" value="monthly" checked="checked" data-amount="100">
      <label for="monthly">Monthly</label>
      <input type="radio" name="plan" id="annual" value="annual" data-amount="600">
      <label for="annual">Annual</label>
    </fieldset>

    <button id="customButton">Sign Up</button>
  <% end %>

  <div style="text-align:center; padding: .5em;">OR</div>

  <%= render "devise/shared/buttons" %>

  <script>
    var radioAmount = function() {
      return $('input[name="plan"]:checked').data('amount');
    }

    var payButtonText = function() {
      if ( $('input[name="plan"]:checked').val() == 'monthly' ) {
        return "{{amount}} per user per mo.";
      } else {  //  $('input[name="plan"]:checked').val() == 'annual' )
        return "{{amount}} per user per yr.";
      }
    };

    var handler = StripeCheckout.configure({
      key: "<%= Rails.configuration.stripe[:publishable_key] %>",
      // image: "<%= image_path 'logo_229x235.png' %>",
      token: function(token) {
        // Use the token to create the charge with a server-side script.
        // You can access the token ID with `token.id`
        $("#stripeToken").val( token.id );
        $("#stripeEmail").val( token.email );
        $('form#new_user_registration').submit();
      }
    });

    $('#customButton').on('click', function(e) {
      // Open Checkout with further options
      handler.open({
        description: '30 Day Free Trial',
        allowRememberMe: false,
        amount: radioAmount(),
        panelLabel: payButtonText()
      });
      e.preventDefault();
    });

    // Close Checkout on page navigation
    $(window).on('popstate', function() {
      handler.close();
    });
  </script>
</div><!-- data-role="page" -->
